---
title: "land_cover"
author: "Anna Calle"
date: "5/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required libraries
library(raster)
library(sf)
library(sp)
library(foreign)
library(maps)
library(mapdata)
library(ggplot2)
library(ggspatial)
library(ggrepel)
```

Set-Up for Downloading Data Using Google Drive File Stream
```{r}
# Create a Root to Extract Files 
if(Sys.info()["sysname"] == "Windows"){ # If operating system is "Windows" use G: Drive
  team_path <- "G:/"
} else { # If it is not (i.e. Mac), use the Google Drive File Stream
  team_path <- "/Volumes/GoogleDrive/"
}

# Create the Full File Path
path <- paste0(team_path, "Shared drives/ESM232/Data")

```

CRS
```{r}
# Assign projection: NAD83
NAD83 <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83
+units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
```

# CA
```{r}
# grab US states from maps package
california <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE)) %>% 
  filter(ID == "california")

# make the polygon the same CRS as rasters
california_project <- st_transform(california, NAD83)

```

# CA Counties
```{r}
# Read file,select columns, and reproject
CA_counties <- read_sf(dsn = paste0(path, "/CA_Counties"),
                layer = "CA_Counties_TIGER2016") %>% 
  dplyr::select(NAME, ALAND, AWATER, geometry) %>% 
  st_transform(NAD83) 

# Plot
plot(CA_counties$geometry)

```

# DEM 
```{r}
# read file
dem <- raster(paste0(path, "/"))

#reproject 
dem_proj <- projectRaster(dem, crs = NAD83)

# crop to CA
dem_crop <- crop(dem_proj, california_project)

# mask to CA
dem_mask <- mask(dem_crop, california_project)

```
# Slope
```{r}

# calculate slope
slope <- terrain(dem_mask, opt = 'slope', unit = 'degrees')

```

# Slope 2
```{r}
# Read files for CA
slope2_a <- raster(paste0(path, "/lf83893613_US_SLP2016/US_SLP2016_US_SLP2016.tif"))
slope2_b <- raster(paste0(path, "/lf04540208_US_SLP2016/US_SLP2016_US_SLP2016.tif"))
slope2_c <- raster(paste0(path, "/lf88648117_US_SLP2016/US_SLP2016_US_SLP2016.tif"))
slope2_d <- raster(paste0(path,"/lf34891549_US_SLP2016/US_SLP2016_US_SLP2016.tif"))

# Plot
plot(slope2_a)
plot(slope2_b)
plot(slope2_c)
plot(slope2_d)

# Merge files
slope2 <- merge(slope2_a, slope2_b, slope2_c, slope2_d)

# Crop
slope2_cropped <- crop(slope2, CA_counties)

# Mask
slope2_masked <-mask(slope2_cropped, CA_counties)

# Plot
plot(slope2)

# Save
writeRaster(x = slope2, filename = paste0(path,"/slope_CA.tif"), overwrite = T)
```

# Slope suitability
```{r}
# Read file
slope_CA <- raster(paste0(path,"/slope_CA.tif"))

# Reclassify matrix ( 0s into 1s and viceversa)
rcl_mat_slope <- c(-Inf, 5, 1,
                   5, Inf, 0)

# Reclassify
slope_binary <- reclassify(slope_CA, rcl = rcl_mat_slope, progress = 'text')

# Plot
plot(slope_binary)
```

# Land cover
```{r}
# Read File
land_cover <- raster(paste0(path, "/gaplf2011lc_v30_CA/gaplf2011lc_v30_ca.tif"), RAT = TRUE)

# Read dbf
land_cover_dbf <- read.dbf(paste0(path, "/gaplf2011lc_v30_CA/gaplf2011lc_v30_ca.tif.vat.dbf"))

# Read txt
land_cover_txt <- read.delim(paste0(path,"/gaplf2011lc_v30_CA/GAP_LANDFIRE_National_Terrestrial_Ecosystems_2011_Attributes.txt"), header = TRUE, sep = "\t") %>% 
  dplyr::select(Value, NVC_CLASS) 

# Plot
plot(land_cover)
```

# Developed & Other Human Use
```{r}
# Get values that correspond to development from land_cover_txt
developed_values <- land_cover_txt %>% 
  dplyr::filter(NVC_CLASS == "Developed & Other Human Use")

# Select pixels in land cover raster with values
developed <- land_cover %in% developed_values[,1]

# Reclassify matrix ( 0s into 1s and viceversa)
rcl_mat <- c(-Inf, 0.1, 1,
                   0.9, Inf, 0)

# Reclassify
developed_binary <- reclassify(developed, rcl = rcl_mat, progress = 'text')

# Plot
plot(developed_binary)

# Save
writeRaster(x = developed_binary, filename = paste0(path,"/developed_binary.tif"), overwrite = T)
```

# Open water
```{r}
# Get values that correspond to open water from land_cover_txt
open_water_values <- land_cover_txt %>% 
  dplyr::filter(NVC_CLASS == "Open Water")

# Select pixels in land cover raster with values
open_water <- land_cover %in% open_water_values[,1]

# Reclassify
open_water_binary <- reclassify(open_water, rcl = rcl_mat, progress = 'text')

# Plot
plot(open_water_binary)

# Save
writeRaster(x = open_water_binary, filename = paste0(path,"/open_water_binary.tif"), overwrite = T)
```

# Forest and Woodland
```{r}
# Get values that correspond to forest from land_cover_txt
forest_values <- land_cover_txt %>% 
  dplyr::filter(NVC_CLASS == "Forest & Woodland")

# Select pixels in land cover raster with those values
forest <- land_cover %in% forest_values[,1]

# Reclassify
forest_binary <- reclassify(forest, rcl = rcl_mat, progress = 'text')

# Plot
plot(forest_binary)

# Save
writeRaster(x = forest_binary, filename = paste0(path,"/forest_binary.tif"), overwrite = T)
```


# Agricultural and Developed
```{r}
# Get values that correspond to agricultural and developed from land_cover_txt
ag_values <- land_cover_txt %>% 
  dplyr::filter(NVC_CLASS == "Agricultural & Developed Vegetation")

# Select pixels in land cover raster with those values
 ag <- land_cover %in% ag_values[,1]

# Reclassify
ag_binary <- reclassify(ag, rcl = rcl_mat, progress = 'text')

# Plot
plot(ag_binary)

# Save
writeRaster(x = ag_binary, filename = paste0(path,"/ag_binary.tif"), overwrite = T)
```


# Aquatic vegetation
```{r}
# Get values that correspond to aquatic vegetation from land_cover_txt
aquatic_values <- land_cover_txt %>% 
  dplyr::filter(NVC_CLASS == "Aquatic Vegetation")

# Select pixels in land cover raster with those values
aquatic <- land_cover %in% aquatic_values[,1]

# Reclassify
aquatic_binary <- reclassify(ag, rcl = rcl_mat, progress = 'text')

# Plot
plot(aquatic_binary)

# Save
writeRaster(x = aquatic_binary, filename = paste0(path,"/aquatic_binary.tif"), overwrite = T)
```


# Suitable raster
```{r}
# Overlay layers
suitable <- overlay(developed_binary,
                    open_water_binary,
                    forest_binary,
                    ag_binary,
                    aquatic_binary,
                    fun = function (a,b,c,d,e) {a*b*c*d*e},
                    progress = 'text')

# Mask
suitable_masked <- suitable %>% 
  mask(CA_counties)

# Plot
plot(suitable_masked)

# Save
writeRaster(x = suitable, filename = paste0(path,"/suitable.tif"), overwrite = T)
```

# % Suitable Land
```{r}
# Read in saved file (instead of loading all layers in suitability anlalysis)
suitable <- raster(paste0(path,"/suitable.tif"))

# Add suitable area column
CA_counties$suitable_area <- NA

# Add suitable area percentage column
CA_counties$suitable_pct <- NA

# Loop through each county
for(i in 1:nrow(CA_counties)) {
  print(i)
  
  # Select ith county
  county <- CA_counties[i, ]
  
  # Crop
  suitable_cropped <- crop(suitable, county)
  
  # Mask
  suitable_masked <- mask(suitable_cropped, county, progress = 'text')
  
  # Count suitable cells
  count <-  freq(suitable_masked, value = 1)
  
  # Calculate area (number of cells * cell resolution)
  CA_counties$suitable_area[i] <- count * 30 * 30
  
  # Calculate area percentage
  CA_counties$suitable_pct[i] <- CA_counties$suitable_area[i]/CA_counties$ALAND[i]*100
}

# Save dataframe as csv file
write.csv(CA_counties, paste0(path,'/CA_counties.csv'))

```

# Suitable Land % Map 
```{r}
# Labels
counties_points<- cbind(CA_counties, st_coordinates(st_centroid(CA_counties$geometry)))

# Map
suitable_pct_map <- ggplot() +
  geom_sf(data = CA_counties,
          color = "gray30", 
          size = 0.1,
          aes(fill = CA_counties$suitable_pct)) +
  scale_fill_continuous(
    name = "Suitable Land \n Percentage",
    low = "red",
    high = "green"
  ) +
  geom_text_repel( data = counties_points,
                   size = 2,
             aes( x = X, y = Y,label = NAME)) + theme_void() +
  theme_minimal() +
  coord_sf(datum=NA) +
  labs(x = "", y = "", title = "Solar Energy in CA") +
  annotation_scale(location = "bl", style = "ticks") # scale bar

suitable_pct_map
```


# Suitable Land Map (raster + counties)
```{r}
# Convert suitable raster to data frame
suitable_df <- as.data.frame(suitable, xy = TRUE)

# Map
suitable_map <- ggplot() +
  geom_sf(data = CA_counties) +
  geom_raster(data = suitable_df) +
   theme_minimal() +
  coord_sf(datum=NA) +
  labs(x = "", y = "", title = "Solar Energy in CA")

suitable_map
```



#########################################################
# Additional data
#########################################################

# Transmission lines
```{r}
# Read File
transmission_lines <- read_sf(dsn = paste0(path, "/transmission_lines"),
                layer = "transmission_lines") %>% 
  st_transform(NAD83)

# Plot
plot(transmission_lines$geometry)
```

# Lakes and reservoires
```{r}
# Read File
lakes <- read_sf(dsn = paste0(path, "/NHD_MajorLakesAndReservoirs"),
                layer = "NHD_MajorLakesAndReservoirs")
# Plot
plot(lakes$geometry)
```

# Major rivers
```{r}
# Read File
rivers <- read_sf(dsn = paste0(path, "/NHD_MajorRivers"),
                layer = "NHD_MajorRivers") %>% 
  st_zm(drop = TRUE)

# Plot
plot(rivers$geometry)
```

# Roads
```{r}
# Read File
roads <- read_sf(dsn = paste0(path, "/tl_2015_06_prisecroads"),
                layer = "tl_2015_06_prisecroads") %>% 
  st_transform(NAD83)

# Plot
plot(roads$geometry)
```

Buffered transmission lines
```{r}
# Buffer 10,000 m from transmission lines and merge polygons
tl_buffered_10000 <- st_buffer(transmission_lines$geometry, 10000) %>% 
  st_union() %>% 
  as_Spatial()

# Buffer 500 m from transmission lines and merge polygons
tl_buffered_500 <- st_buffer(transmission_lines$geometry, 500) %>% 
  st_union() %>% 
  as_Spatial()

# Plot
plot(tl_buffered_10000)
plot(tl_buffered_500)

# Blank raster
r <- raster(nrow = nrow(land_cover), ncol = ncol(land_cover), crs = NAD83, ext = extent(tl_buffered_10000))

# Rasterize buffered transmission lines
# Note: use progress='text' to see progress
tl_raster_10000 <- rasterize(tl_buffered_10000, r, field = 1, progress='text')
tl_raster_500 <- rasterize(tl_buffered_500, r, field = 0, background = 1, progress='text')

# Plot
plot(tl_raster_10000)
plot(tl_raster_500)

# Overlay two rasters
tl_raster <- overlay(tl_raster_10000, tl_raster_500, fun = function(a,b) {a*b}, progress='text')

# Plot
plot(tl_raster)

# Save raster
writeRaster(x = tl_raster, filename = paste0(path,"/tl_raster.tif"), overwrite = T)

```

Buffered roads
```{r}
# Buffer 10,000 m from roads and merge polygons
roads_buffered_10000 <- st_buffer(roads$geometry, 10000) %>% 
  st_union() %>% 
  as_Spatial()

# Buffer 500 m from roads and merge polygons
roads_buffered_500 <- st_buffer(roads$geometry, 500) %>% 
  st_union() %>% 
  as_Spatial()

# Plot
plot(roads_buffered_10000)
plot(roads_buffered_500)

# Blank raster
r <- raster(nrow = nrow(land_cover), ncol = ncol(land_cover), crs = NAD83, ext = extent(roads_buffered_10000))

# Rasterize buffered roads
# Note: use progress='text' to see progress
roads_raster_10000 <- rasterize(roads_buffered_10000, r, field = 1, progress='text')
roads_raster_500 <- rasterize(roads_buffered_500, r, field = 0, background = 1, progress='text')

# Plot
plot(roads_raster_10000)
plot(roads_raster_500)

# Overlay two rasters
roads_raster <- overlay(roads_raster_10000, roads_raster_500, fun = function(a,b) {a*b}, progress='text')

# Plot
plot(roads_raster)

# Save raster
writeRaster(x = roads_raster, filename = paste0(path,"/roads_raster.tif"), overwrite = T)

```




