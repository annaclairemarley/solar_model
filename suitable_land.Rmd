---
title: "land_cover"
author: "Anna Calle"
date: "5/17/2020"
output: html_document
---

Data is separated into:
- Raw: raw data as downloaded
- In: renamed data used in R
- Out: data saved from R

Layers that won't change through time for the suitability analysis:
- slope
- open water

Layers that could change through time and could be used as optional inputs for the land suitability submodel:
- developed
- forest and woodland
- agricultural
- aquatic vegetation


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required libraries
library(tidyverse)
library(raster)
library(sf)
library(sp)
library(foreign)
library(maps)
library(mapdata)
library(ggplot2)
library(ggspatial)
library(ggrepel)
library(paletteer)
```

Set-Up for Downloading Data Using Google Drive File Stream
```{r}
# Create a Root to Extract Files 
if(Sys.info()["sysname"] == "Windows"){ # If operating system is "Windows" use G: Drive
  team_path <- "G:/"
} else { # If it is not (i.e. Mac), use the Google Drive File Stream
  team_path <- "/Volumes/GoogleDrive/"
}

# Create the Full File Paths for Inputs and Outputs
In <- paste0(team_path, "Shared drives/ESM232/Data/in/") # cannot use "in" as name
out <- paste0(team_path, "Shared drives/ESM232/Data/out/")

```

CRS
```{r}
# Assign projection: NAD83
NAD83 <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83
+units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
```

# CA
```{r}
# grab US states from maps package
california <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE)) %>% 
  filter(ID == "california")

# make the polygon the same CRS as rasters
CA_proj <- st_transform(california, NAD83)

# Save shapefile (to read inside function)
st_write(CA_proj, paste0(out, "/CA_proj.shp"), delete_layer = TRUE)

```

# CA Counties
```{r}
# grab US counties from maps package
counties_CA <- st_as_sf(maps::map("county", "california", plot = FALSE, fill = TRUE))

# reproject, remove state from county names, and calculate area
counties_proj <- st_transform(counties_CA, NAD83) %>% 
  separate("ID", c("State", "County"), sep=",") %>% 
  dplyr::select(-"State") %>% 
  mutate(area = st_area(geom))

# Save shapefile
st_write(counties_proj, paste0(out, "/counties_proj.shp"), delete_layer = TRUE)
```

# Land cover USGS

Land use/land cover (LULC) class identification code. 
01 = Water, 
02 = Developed, 
03 = Transportation/Other Developed, 
04 = Mining (not used), 
05 = Barren, **
06 = Forest, 
07 = Grassland, **
08 = Annual Agriculture, 
09 = Wetlands, 
10 = Shrublands, **
11 = SnowIce, 
12 = Perennial Agriculture

```{r}
# Read file
land_cover <- raster(paste0(In, "land_cover_2020.tif"))

# Get suitable values
suitable_lc_values <- c(5, 7, 10)

# Select pixels with those values
suitable_lc <- land_cover %in% suitable_lc_values

# Mask
suitable_lc_binary <- mask(suitable_lc, CA_proj)

# Plot
plot(suitable_lc_binary)

# Save
writeRaster(x = suitable_lc_binary, filename = paste0(out,"suitable_lc_binary.tif"), overwrite = T)

```

# Slope (no need to run)
```{r}
# Read files for CA
slope_a <- raster(paste0(In, "slope_a.tif"))
slope_b <- raster(paste0(In, "/slope_b.tif"))
slope_c <- raster(paste0(In, "/slope_c.tif"))
slope_d <- raster(paste0(In,"/slope_d.tif"))

# Merge files
slope <- merge(slope_a, slope_b, slope_c, slope_d, progress = 'text')

# Crop
slope_cropped <- crop(slope, CA_proj)

# Mask
slope_masked <-mask(slope_cropped, CA_proj)

# Change resolution
slope_small <- raster::resample(slope_masked, land_cover, method='bilinear')

# Plot
plot(slope_small)

# Save
writeRaster(x = slope_small, filename = paste0(out,"slope_CA.tif"), overwrite = T)
```

# Slope suitability
```{r}
# Read file
slope_CA <- raster(paste0(out,"slope_CA.tif"))

# Reclassify matrix ( 0s into 1s and viceversa)
rcl_mat_slope <- c(-Inf, 5, 1,
                   5, Inf, 0)

# Reclassify
slope_binary <- reclassify(slope_CA, rcl = rcl_mat_slope, progress = 'text')

# Plot
plot(slope_binary)

# Save
writeRaster(x = slope_binary, filename = paste0(out,"slope_binary.tif"), overwrite = T)
```


# % Suitable Land
```{r}
# Read in saved file (instead of loading all layers in suitability anlalysis)
suitable <- raster(paste0(out,"suitable.tif"))

# Add suitable area column
counties_proj$suitable_area <- NA

# Add suitable area percentage column
counties_proj$suitable_pct <- NA

# Loop through each county
for(i in 1:nrow(counties_proj)) {
  print(i)
  
  # Select ith county
  county <- counties_proj[i, ]
  
  # Crop
  suitable_cropped <- crop(suitable, county)
  
  # Mask
  suitable_masked <- mask(suitable_cropped, county, progress = 'text')
  
  # Count suitable cells
  count <-  freq(suitable_masked, value = 1)
  
  # Calculate area (number of cells * cell resolution)
  counties_proj$suitable_area[i] <- count * 1000 * 1000
  
  # Calculate area percentage
  counties_proj$suitable_pct[i] <- counties_proj$suitable_area[i]/counties_proj$area[i]*100
}

# Create rank column
counties_proj$rank <- NA

# Rank counties by % of suitable land
counties_proj$rank[order(counties_proj$suitable_pct)] <- 1:nrow(counties_proj)

# Rank dataframe
counties_rank_df <- as.data.frame(counties_proj) %>% 
  select(County, rank)

# Save dataframe as csv file
write.csv(counties_proj, paste0(out,'counties_area.csv'))

```

# Suitable Land % Map 
```{r}
# Labels
counties_points<- cbind(counties_proj, st_coordinates(st_centroid(counties_proj$geometry)))

# Map
suitable_pct_map <- ggplot() +
  geom_sf(data = counties_proj,
          color = "gray30", 
          size = 0.1,
          aes(fill = counties_proj$suitable_pct)) +
  scale_fill_paletteer_c("ggthemes::Temperature Diverging") +
  geom_text_repel( data = counties_points,
                   size = 2,
             aes( x = X, y = Y,label = County)) + 
  theme_minimal() +
  coord_sf(datum=NA) +
  labs(x = "", y = "", title = "Solar Energy in CA") +
  annotation_scale(location = "bl", style = "ticks") # scale bar

suitable_pct_map
```


# Suitable Land Map (raster + counties)
```{r}
# Convert suitable raster to data frame
suitable_df <- as.data.frame(suitable, xy = TRUE)

# Map
suitable_map <- ggplot() +
  geom_raster(data = suitable_df,
               mapping = aes(x = x, y = y,  fill = layer )) +
  
  geom_sf(data = counties_proj,
          fill = "transparent",
          color = "gray30", 
          size = 0.1) +
  scale_fill_paletteer_c("ggthemes::Temperature Diverging",
                         na.value = "transparent") +
   theme_minimal() +
  coord_sf(datum=NA) +
  labs(x = "", y = "", title = "Solar Energy in CA") +
  annotation_scale(location = "bl", style = "ticks") # scale bar

suitable_map
```


# Function to obtain suitability raster of CA
```{r}
suitability_fun <- function (land_cover_raster,
                             slope_threshold = 5,
                             land_cover_suitable_values = c(5, 7, 10) ) {
  
  ### Slope ###
  # Read slope file
  slope_CA <- raster(paste0(out,"slope_CA.tif"))
  
  # Read CA file
  CA_proj <- read_sf(dsn = out,
                layer = "counties_proj")
  
  # Reclassify matrix ( 0s into 1s and viceversa)
rcl_mat_slope <- c(-Inf, slope_threshold, 1,
                  slope_threshold, Inf, 0)
  
  # Reclassify
slope_binary <- reclassify(slope_CA, rcl = rcl_mat_slope, progress = 'text')


### Land cover ###
# Select pixels with those values
suitable_lc <- land_cover_raster %in% land_cover_suitable_values

# Mask
suitable_lc_binary <- mask(suitable_lc, CA_proj)


### Suitability ###
# Overlay layers
suitable <- overlay(slope_binary,
                    suitable_lc_binary,
                    fun = function (a,b) {a*b},
                    progress = 'text')

# Mask
suitable_masked <- suitable %>% 
  mask(CA_proj)

# Plot
plot(suitable_masked)

# Return raster
return(suitable_masked)
}

# Test function
suitable <- suitability_fun(land_cover_raster = land_cover)
  
```


# Function to map suitability by county
```{r}
map_suitability_fun <- function(suitable_raster) {

  ### Map of suitable raster with county boundaries ###
  # Read CA counties file
  counties_proj <- read_sf(dsn = out,
                           layer = "counties_proj")
  
  # Read CA file
  CA_proj <- read_sf(dsn = out,
                     layer = "counties_proj")
  
  # Convert suitable raster to data frame
  suitable_df <- as.data.frame(suitable, xy = TRUE)
  
 # Map
suitable_map <- ggplot() +
  geom_raster(data = suitable_df,
               mapping = aes(x = x, y = y,  fill = layer )) +
  
  geom_sf(data = counties_proj,
          fill = "transparent",
          color = "gray30", 
          size = 0.1) +
  scale_fill_paletteer_c("ggthemes::Temperature Diverging",
                         na.value = "transparent") +
   theme_minimal() +
  coord_sf(datum=NA) +
  labs(x = "", y = "", title = "Solar Energy in CA") +
  annotation_scale(location = "bl", style = "ticks") # scale bar
  
  
  ### Calculating % of suitable land by county ###
  
  # Add suitable area column
  counties_proj$suitable_area <- NA
  
  # Add suitable area percentage column
  counties_proj$suitable_pct <- NA
  
  # Loop through each county
  for (i in 1:nrow(counties_proj)) {
    print(i)
    
    # Select ith county
    county <- counties_proj[i,]
    
    # Crop
    suitable_cropped <- crop(suitable_raster, CA_proj)
    
    # Mask
    suitable_masked <-
      mask(suitable_cropped, CA_proj, progress = 'text')
    
    # Count suitable cells
    count <-  freq(suitable_masked, value = 1)
    
    # Calculate area (number of cells * cell resolution)
    counties_proj$suitable_area[i] <- count * 1000 * 1000
    
    # Calculate area percentage
    counties_proj$suitable_pct[i] <-
      counties_proj$suitable_area[i] / counties_proj$area[i] * 100
  }
  
  ### Map percent suitable by county ###
  # Labels
  counties_points <-
    cbind(counties_proj, st_coordinates(st_centroid(counties_proj$geometry)))
  
  # Map
suitable_pct_map <- ggplot() +
  geom_sf(data = counties_proj,
          color = "gray30", 
          size = 0.1,
          aes(fill = counties_proj$suitable_pct)) +
  scale_fill_paletteer_c("ggthemes::Temperature Diverging") +
  geom_text_repel( data = counties_points,
                   size = 2,
             aes( x = X, y = Y,label = County)) + 
  theme_minimal() +
  coord_sf(datum=NA) +
  labs(x = "", y = "", title = "Solar Energy in CA") +
  annotation_scale(location = "bl", style = "ticks") # scale bar
  
  ### Calculating county rankings ###
  # Create rank column
  counties_proj$rank <- NA
  
  # Rank counties by % of suitable land
  counties_proj$rank[order(counties_proj$suitable_pct)] <-
    1:nrow(counties_proj)
  
  # Rank dataframe
  counties_rank_df <- as.data.frame(counties_proj) %>% 
  select(County, rank)
  
  ### Map rankings ###
  
  
  return(list(suitable_map, suitable_pct_map, counties_rank_df))
  
}

# Test function

outputs <- map_suitability_fun(suitable_raster = suitable)




```


#########################################################
# Additional data
#########################################################

# Transmission lines
```{r}
# Read File
transmission_lines <- read_sf(dsn = paste0(path, "/transmission_lines"),
                layer = "transmission_lines") %>% 
  st_transform(NAD83)

# Plot
plot(transmission_lines$geometry)
```

# Lakes and reservoires
```{r}
# Read File
lakes <- read_sf(dsn = paste0(path, "/NHD_MajorLakesAndReservoirs"),
                layer = "NHD_MajorLakesAndReservoirs")
# Plot
plot(lakes$geometry)
```

# Major rivers
```{r}
# Read File
rivers <- read_sf(dsn = paste0(path, "/NHD_MajorRivers"),
                layer = "NHD_MajorRivers") %>% 
  st_zm(drop = TRUE)

# Plot
plot(rivers$geometry)
```

# Roads
```{r}
# Read File
roads <- read_sf(dsn = paste0(path, "/tl_2015_06_prisecroads"),
                layer = "tl_2015_06_prisecroads") %>% 
  st_transform(NAD83)

# Plot
plot(roads$geometry)
```

Buffered transmission lines
```{r}
# Buffer 10,000 m from transmission lines and merge polygons
tl_buffered_10000 <- st_buffer(transmission_lines$geometry, 10000) %>% 
  st_union() %>% 
  as_Spatial()

# Buffer 500 m from transmission lines and merge polygons
tl_buffered_500 <- st_buffer(transmission_lines$geometry, 500) %>% 
  st_union() %>% 
  as_Spatial()

# Plot
plot(tl_buffered_10000)
plot(tl_buffered_500)

# Blank raster
r <- raster(nrow = nrow(land_cover), ncol = ncol(land_cover), crs = NAD83, ext = extent(tl_buffered_10000))

# Rasterize buffered transmission lines
# Note: use progress='text' to see progress
tl_raster_10000 <- rasterize(tl_buffered_10000, r, field = 1, progress='text')
tl_raster_500 <- rasterize(tl_buffered_500, r, field = 0, background = 1, progress='text')

# Plot
plot(tl_raster_10000)
plot(tl_raster_500)

# Overlay two rasters
tl_raster <- overlay(tl_raster_10000, tl_raster_500, fun = function(a,b) {a*b}, progress='text')

# Plot
plot(tl_raster)

# Save raster
writeRaster(x = tl_raster, filename = paste0(path,"/tl_raster.tif"), overwrite = T)

```

Buffered roads
```{r}
# Buffer 10,000 m from roads and merge polygons
roads_buffered_10000 <- st_buffer(roads$geometry, 10000) %>% 
  st_union() %>% 
  as_Spatial()

# Buffer 500 m from roads and merge polygons
roads_buffered_500 <- st_buffer(roads$geometry, 500) %>% 
  st_union() %>% 
  as_Spatial()

# Plot
plot(roads_buffered_10000)
plot(roads_buffered_500)

# Blank raster
r <- raster(nrow = nrow(land_cover), ncol = ncol(land_cover), crs = NAD83, ext = extent(roads_buffered_10000))

# Rasterize buffered roads
# Note: use progress='text' to see progress
roads_raster_10000 <- rasterize(roads_buffered_10000, r, field = 1, progress='text')
roads_raster_500 <- rasterize(roads_buffered_500, r, field = 0, background = 1, progress='text')

# Plot
plot(roads_raster_10000)
plot(roads_raster_500)

# Overlay two rasters
roads_raster <- overlay(roads_raster_10000, roads_raster_500, fun = function(a,b) {a*b}, progress='text')

# Plot
plot(roads_raster)

# Save raster
writeRaster(x = roads_raster, filename = paste0(path,"/roads_raster.tif"), overwrite = T)

```




